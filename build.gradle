plugins {
    id 'java'
    id 'application'
    id 'idea'
}

group = 'net.minecraft'
version = 'b1.2_02'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

repositories {
    mavenCentral()
    maven { url = 'https://libraries.minecraft.net' }
    maven { url = 'https://repo.legacyfabric.net/repository/legacyfabric/' }
}

def lwjglVersion = '2.9.4-nightly-20150209'
def lwjglNatives = 'natives-linux'
def nativesDir = file("${buildDir}/natives").absolutePath

dependencies {
    // LWJGL 2
    implementation "org.lwjgl.lwjgl:lwjgl:${lwjglVersion}"
    implementation "org.lwjgl.lwjgl:lwjgl_util:${lwjglVersion}"
    runtimeOnly "org.lwjgl.lwjgl:lwjgl-platform:${lwjglVersion}:${lwjglNatives}"

    // Paulscode Sound System
    implementation 'com.paulscode:codecjorbis:20101023'
    implementation 'com.paulscode:codecwav:20101023'
    implementation 'com.paulscode:libraryjavasound:20101123'
    implementation 'com.paulscode:librarylwjglopenal:20100824'
    implementation 'com.paulscode:soundsystem:20120107'

    // JOrbis for Ogg Vorbis
    implementation 'org.jcraft:jorbis:0.0.17'
}

application {
    mainClass = 'net.minecraft.client.Minecraft'
    applicationDefaultJvmArgs = [
        "-Djava.library.path=${nativesDir}",
        "-Dorg.lwjgl.librarypath=${nativesDir}",
        "-Dnet.java.games.input.librarypath=${nativesDir}",
        // Java 21 compatibility for LWJGL2
        "-Dorg.lwjgl.opengl.Display.allowSoftwareOpenGL=true",
        "--add-opens=java.base/java.lang=ALL-UNNAMED",
        "--add-opens=java.desktop/sun.awt=ALL-UNNAMED",
        "--add-opens=java.desktop/java.awt=ALL-UNNAMED"
    ]
}

tasks.register('extractNatives', Copy) {
    dependsOn configurations.runtimeClasspath
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    from {
        configurations.runtimeClasspath.findAll { it.name.contains('natives') }.collect { zipTree(it) }
    }
    into "${buildDir}/natives"
}

tasks.named('run') {
    dependsOn extractNatives
    workingDir = file('run')
    doFirst {
        workingDir.mkdirs()
    }
}

// Configure IntelliJ IDEA
idea {
    module {
        inheritOutputDirs = true
        downloadJavadoc = true
        downloadSources = true
    }
}

// Generate IntelliJ run configuration
tasks.register('generateIntellijRun') {
    dependsOn extractNatives
    group = 'ide'
    description = 'Generates IntelliJ IDEA run configuration'

    doLast {
        def runConfigDir = file('.idea/runConfigurations')
        runConfigDir.mkdirs()

        file("${runConfigDir}/Minecraft_Client.xml").text = """<component name="ProjectRunConfigurationManager">
  <configuration default="false" name="Minecraft Client" type="Application" factoryName="Application">
    <option name="MAIN_CLASS_NAME" value="net.minecraft.client.Minecraft" />
    <module name="${project.name}.main" />
    <option name="PROGRAM_PARAMETERS" value="Dev -" />
    <option name="VM_PARAMETERS" value="-Djava.library.path=${nativesDir} -Dorg.lwjgl.librarypath=${nativesDir} -Dnet.java.games.input.librarypath=${nativesDir}" />
    <option name="WORKING_DIRECTORY" value="\$ProjectFileDir\$/run" />
    <method v="2">
      <option name="Make" enabled="true" />
    </method>
  </configuration>
</component>"""

        println "IntelliJ run configuration generated at ${runConfigDir}/Minecraft_Client.xml"
        println "Reload the project in IntelliJ to see the run configuration"
    }
}

// Auto-extract natives on build
tasks.named('classes') {
    dependsOn extractNatives
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'
    options.compilerArgs += ['-Xlint:-deprecation', '-Xlint:-unchecked']
}
